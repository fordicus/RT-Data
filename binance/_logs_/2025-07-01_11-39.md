## ✅ \[1] `FileNotFoundError` in `merge_day_zips_to_single_jsonl()`

### 🔍 문제 요약

```
FileNotFoundError: [Errno 2] No such file or directory: './data/binance/orderbook/BTCUSDC_orderbook_2025-06-27.jsonl'
```

### 🧠 가능한 원인

이 오류는 다음 두 조건 중 하나라도 만족될 때 발생합니다:

1. `merged_path` 파일을 생성한 직후 삭제되었거나 생성 자체가 실패.
2. `tmp_dir`에는 `.zip` 파일이 있었으나, 내부에 `.jsonl`을 포함하지 않음 → `merged_path`에 아무것도 쓰이지 않음 → 후처리에서 `os.remove(merged_path)` 호출 시 해당 파일이 없어서 에러 발생.

### 💡 개선 방안

```python
# before removing merged_path, ensure it was written
if os.path.exists(merged_path):
	os.remove(merged_path)
```

또는, 다음과 같이 **empty file인지 확인**하는 방식도 가능:

```python
if os.path.exists(merged_path) and os.path.getsize(merged_path) > 0:
	os.remove(merged_path)
else:
	logger.warning(f"Nothing to merge for {symbol}@{day_str}")
```

---

## ✅ \[2] `WebSocket` 오류들 (keepalive timeout, `gaierror`)

### 🔍 증상

* `sent 1011 (unexpected error) keepalive ping timeout`
* `socket.gaierror: [Errno -3] Temporary failure in name resolution`

### 🧠 원인 해석

| 오류 유형                  | 의미                                           |
| ---------------------- | -------------------------------------------- |
| `1011` WebSocket close | Binance 서버 측 장애 또는 네트워크 불안정                  |
| `gaierror -3`          | DNS name resolution 실패 (서버가 일시적으로 인터넷 불가 상태) |

### 💡 개선 방안

1. **자동 재연결 로직은 이미 구현됨** (`exponential backoff` + `RESET_CYCLE_AFTER`)
2. 그러나 **DNS 오류는 시스템 측 로그로 명확히 남기기** 위해 다음 로직 추가 권장:

```python
except socket.gaierror as e:
	logger.error(f"DNS resolution failed: {e}. Check internet connectivity.")
```

또한, `websockets.connect()`에 `ping_timeout` 값을 늘리는 옵션도 고려:

```python
async with websockets.connect(WS_URL, ping_timeout=20) as ws:
```

---

## ✅ \[3] `LOGGING`: 로그 파일 저장 + 타임스탬프 미출력 문제

### 🔍 현재 상황

* `uvicorn.error` logger를 쓰고 있지만, **파일 저장 설정 없음**
* 기본 로그 포맷에 타임스탬프 없음

### 💡 개선 방안

아래를 `stream_binance.py` 최상단 어딘가 (예: `FastAPI()` 선언 전)에 추가해 주세요:

```python
# ── Set up rotating log to file + console ───────────────────────────────
from logging.handlers import RotatingFileHandler

log_formatter = logging.Formatter("[%(asctime)s] %(levelname)s: %(message)s")

file_handler = RotatingFileHandler("stream_binance.log", maxBytes=10_000_000, backupCount=3)
file_handler.setFormatter(log_formatter)

console_handler = logging.StreamHandler()
console_handler.setFormatter(log_formatter)

logger = logging.getLogger("uvicorn.error")
logger.setLevel(logging.INFO)
logger.addHandler(file_handler)
logger.addHandler(console_handler)
```

이렇게 하면:

* `stream_binance.log`에 로그 저장 (10MB 이상이면 backup)
* 콘솔 출력에도 `[시간] 로그레벨: 메시지` 형식 유지

---

## ✅ \[4] 구조 점검: `REPO_STRUCT.html` 분석

### 📂 REPO 구조 요약 (추정)

* `/data/binance/orderbook/temporary/` 아래에 개별 `.zip` 저장
* `/data/binance/orderbook/`에는 날짜별 `.zip` 병합본 저장
* `templates/`, `get_binance_chart.conf`, `stream_binance.py` 등 잘 배치됨

### 🧠 관찰

* 구조상 파일들은 정상적으로 생성되고 정리되고 있음
* `.zip` 병합이 잘 진행되었음을 보여줌 → `merge_day_zips_to_single_jsonl()` 동작 대체로 성공적

---

## 📌 결론 및 권장 작업 목록 요약

| 문제                  | 개선 방향                                     |
| ------------------- | ----------------------------------------- |
| `FileNotFoundError` | `.jsonl` 존재 확인 후 삭제하도록 안전성 강화             |
| WebSocket 에러        | `ping_timeout` 명시, DNS 실패 시 명확한 로그        |
| 로그 미기록              | `RotatingFileHandler`로 로그파일 기록 + 타임스탬프 출력 |
| 구조 점검               | `REPO_STRUCT.html` 기준, 병합/압축 정상 작동 중      |

---
