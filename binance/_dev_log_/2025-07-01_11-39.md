## ✅ \[1] `FileNotFoundError` in `merge_day_zips_to_single_jsonl()`

### 🔍 문제 요약

```
FileNotFoundError: [Errno 2] No such file or directory: './data/binance/orderbook/BTCUSDC_orderbook_2025-06-27.jsonl'
```

### 🧠 가능한 원인

이 오류는 다음 두 조건 중 하나라도 만족될 때 발생합니다:

1. `merged_path` 파일을 생성한 직후 삭제되었거나 생성 자체가 실패.
2. `tmp_dir`에는 `.zip` 파일이 있었으나, 내부에 `.jsonl`을 포함하지 않음 → `merged_path`에 아무것도 쓰이지 않음 → 후처리에서 `os.remove(merged_path)` 호출 시 해당 파일이 없어서 에러 발생.

### 💡 개선 방안

```python
# before removing merged_path, ensure it was written
if os.path.exists(merged_path):
	os.remove(merged_path)
```

또는, 다음과 같이 **empty file인지 확인**하는 방식도 가능:

```python
if os.path.exists(merged_path) and os.path.getsize(merged_path) > 0:
	os.remove(merged_path)
else:
	logger.warning(f"Nothing to merge for {symbol}@{day_str}")
```

---

## ✅ \[2] `WebSocket` 오류들 (keepalive timeout, `gaierror`)

| 증상                   | 설명                       | 서버측?                     | 클라이언트측?                                            |
| -------------------- | ------------------------ | ------------------------ | -------------------------------------------------- |
| `gaierror(-3)`       | 도메인(Binance)을 IP로 해석 못함  | ❌ Binance는 DNS 서버 아님     | ✅ 클라이언트 로컬 DNS 설정 이상                               |
| `Connection refused` | 서버에 접근 자체 실패             | ❌ Binance는 연결 열어두는 편     | ✅ 클라이언트 네트워크 단절 가능성                                |
| `ping timeout`       | 우리가 ping 보냈는데 pong 응답 없음 | 🤔 둘 다 가능                | ✅ 클라이언트가 pong을 못 받았거나 응답 처리 못함 (CPU 부하, 라우터 딜레이 등) |
| 이후 재시도 성공            | 시간이 지나자 정상 복구            | ❌ Binance가 죽었다면 지속 오류 발생 | ✅ 로컬 회선이나 DNS 문제였을 가능성 높음                          |

| 우선순위     | 리스크 원인                          | 설명                                          | 영향 가능성                                 | 진단 / 대응                                                 |
| -------- | ------------------------------- | ------------------------------------------- | -------------------------------------- | ------------------------------------------------------- |
| 🥇 (최상위) | **Wi-Fi 신호 불안정**                | 구형 노트북 Wi-Fi 모듈 or 공유기 interference         | 🔴 높음 (간헐적 packet loss)                | `ping -i 0.5 8.8.8.8` / `iwconfig`로 SNR 확인, 가능하면 LAN 전환 |
| 🥈       | **DNS fallback 부재**             | `gaierror(-3)`는 `/etc/resolv.conf` 문제 거의 확정 | 🔴 높음 (비연결성 상태 발생)                     | `nameserver 1.1.1.1` 추가 또는 `systemd-resolved` 점검        |
| 🥉       | **라우터 NAT timeout**             | NAT 세션이 장시간 유지되지 않으면 연결 끊김 발생               | 🟠 중간                                  | 공유기 NAT timeout 설정 확인 (최소 10분 이상으로)                     |
| ④        | **Binance 서버의 `pong` 누락 (한시적)** | 상대 서버의 네트워크 hiccup                          | 🟡 낮음 (하지만 가능)                         | 재시도 구조로 완화됨. Binance Status page 모니터링                   |
| ⑤        | **홈서버 CPU 스로틀링**                | `auto-cpufreq`가 주기적으로 conservative 설정 적용    | 🟡 낮음 (light load 서비스지만 loop delay 가능) | `top`, `auto-cpufreq --stats`로 확인                       |
| ⑥        | **라우터 또는 ISP 순간 장애**            | ISP가 DHCP 재할당 / 공유기 재시작 등                   | 🟡 낮음                                  | 로그에 `disconnected` 메시지 없으면 확률 낮음                        |


---

## 📌 결론 및 권장 작업 목록 요약

| 문제                  | 개선 방향                                     |
| ------------------- | ----------------------------------------- |
| `FileNotFoundError` | `.jsonl` 존재 확인 후 삭제하도록 안전성 강화             |
| WebSocket 에러        | `ping_timeout` 명시, DNS 실패 시 명확한 로그        |

---
